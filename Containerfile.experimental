# Containerfile.experimental
# Modular build: silverblue-main + bluefin-common + brew + your customizations
#
# Build:
#   podman build -f Containerfile.experimental -t greatlem0n-os:experimental .
#
# Inspect (fast - no VM needed):
#   podman run --rm greatlem0n-os:experimental rpm -qa | grep firefox
#   podman run --rm greatlem0n-os:experimental ls /usr/lib/systemd/system/ | grep -E "brew|flatpak"
#   podman run --rm greatlem0n-os:experimental cat /etc/some/config
#   podman run --rm -it greatlem0n-os:experimental bash
#
# Test (slow - builds VM):
#   just build-qcow2 localhost/greatlem0n-os experimental
#   just run-vm-qcow2 localhost/greatlem0n-os experimental
###############################################################################
# MULTI-STAGE BUILD ARCHITECTURE
###############################################################################
# This Containerfile can follow the Bluefin architecture pattern as implemented in
# @projectbluefin/distroless. The architecture layers OCI containers together:
#
# 1. Context Stage (ctx) - Combines resources from:
#    - Local build scripts and custom files
#    - @projectbluefin/common - Desktop configuration shared with Aurora 
#    - @ublue-os/brew - Homebrew integration
#
# 2. Base Image Options:
#    - `ghcr.io/ublue-os/silverblue-main:latest` (Fedora and GNOME)
#    - `ghcr.io/ublue-os/base-main:latest` (Fedora and no desktop 
#    - `quay.io/centos-bootc/centos-bootc:stream10 (CentOS-based)` 
#
# See: https://docs.projectbluefin.io/contributing/ for architecture diagram
###############################################################################

###############################################################################
# MODULAR STAGES
###############################################################################
FROM ghcr.io/projectbluefin/common:latest@sha256:b7c9c3b7252d060801797058de24e359282dd691cf83d8511ac50a82f7dbca6e AS bluefin-common
FROM ghcr.io/ublue-os/brew:latest@sha256:f9637549a24a7e02315c28db04cc0827dfc04bb74cea3be5c187f10c262c30d2 AS brew

###############################################################################
# CONTEXT STAGE - your customizations
###############################################################################
FROM scratch AS ctx
COPY build /build
COPY custom /custom
COPY system_files /system_files

###############################################################################
# FINAL IMAGE
###############################################################################
FROM ghcr.io/ublue-os/silverblue-main:latest@sha256:e69ca9cf1365006b7a63feefbec64361a1c7abb339419ac35ab65827577333e5

# Apply bluefin-common shared (ujust, flatpak-preinstall, ublue-system-setup, polkit, udev, etc.)
COPY --from=bluefin-common /system_files/shared /

# Apply bluefin-common bluefin-specific (dconf, branding)
COPY --from=bluefin-common /system_files/bluefin /

# Apply brew (homebrew + services + timers)
COPY --from=brew /system_files /

# Your system files
COPY --from=ctx /system_files/shared /

# Run your build scripts
RUN --mount=type=bind,from=ctx,source=/,target=/ctx \
    --mount=type=cache,dst=/var/cache \
    --mount=type=cache,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    /ctx/build/00-run-all.sh

# Verify final image
RUN bootc container lint
